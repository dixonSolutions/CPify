# Building CPify as a Flatpak

This guide documents how to build and distribute CPify as a Flatpak application.

## Prerequisites

Install Flatpak and flatpak-builder:

### Fedora

```bash
sudo dnf install -y flatpak flatpak-builder
```

### Ubuntu/Debian

```bash
sudo apt install -y flatpak flatpak-builder
```

### Arch Linux

```bash
sudo pacman -S flatpak flatpak-builder
```

## Set Up Flathub

Add the Flathub repository (required for GNOME runtime):

```bash
flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
```

## Install GNOME SDK

Install the GNOME Platform and SDK (required to build):

```bash
flatpak install flathub org.gnome.Platform//47 org.gnome.Sdk//47
```

## Build the Flatpak

### Local Build (Development)

Build and install locally for testing:

```bash
cd CPify

# Build the Flatpak
flatpak-builder --force-clean build-flatpak com.github.dixonsolutions.CPify.yml

# Install locally (user-only)
flatpak-builder --user --install --force-clean build-flatpak com.github.dixonsolutions.CPify.yml
```

### Run the Installed Flatpak

```bash
flatpak run com.github.dixonsolutions.CPify
```

### Create a Distributable Bundle

Create a single-file bundle for distribution:

```bash
# First, build to a repo
flatpak-builder --repo=repo --force-clean build-flatpak com.github.dixonsolutions.CPify.yml

# Create a bundle file
flatpak build-bundle repo cpify.flatpak com.github.dixonsolutions.CPify
```

The `cpify.flatpak` file can be shared and installed on any system with:

```bash
flatpak install cpify.flatpak
```

## Project Structure

The Flatpak build requires these files:

```
CPify/
├── com.github.dixonsolutions.CPify.yml   # Flatpak manifest
├── assets/                                # Application assets (source)
│   ├── ClickSoundEffect.wav              # UI click sound effect
│   ├── CPify Dark Mode Logo.svg          # Logo for dark theme
│   ├── CPify Light Mode Logo.svg         # Logo for light theme
│   └── CPify Official Logo.svg           # Main application logo
├── data/                                  # FreeDesktop integration files
│   ├── com.github.dixonsolutions.CPify.desktop      # Desktop entry
│   ├── com.github.dixonsolutions.CPify.metainfo.xml # AppStream metadata
│   ├── icons/
│   │   └── hicolor/
│   │       └── scalable/
│   │           └── apps/
│   │               └── com.github.dixonsolutions.CPify.svg  # App icon
│   └── meson.build                       # Install rules for data & assets
├── meson.build                            # Root build configuration
└── src/
    └── ...
```

## Asset Packaging

Assets (icons, sounds, logos, UI files) must be installed into the Flatpak sandbox
at standard Linux filesystem locations so they're available at runtime. This section
explains how assets flow from source to the final Flatpak container.

### How It Works

The build chain is: **Source files** -> **Meson install rules** -> **Flatpak builder** -> `/app/share/`

1. The Flatpak manifest (`com.github.dixonsolutions.CPify.yml`) uses `buildsystem: meson`
   with `type: dir, path: .` -- this makes the entire source tree available during build.
2. Meson's `install_data()` in `data/meson.build` copies assets to their install locations.
3. When `flatpak-builder` runs `meson install`, files end up under `/app/` in the sandbox.

### Where Assets Are Installed (Inside the Flatpak)

| Source File | Installed Location | Purpose |
|-------------|-------------------|---------|
| `data/*.desktop` | `/app/share/applications/` | Desktop launcher entry |
| `data/*.metainfo.xml` | `/app/share/metainfo/` | AppStream store metadata |
| `data/icons/hicolor/.../*.svg` | `/app/share/icons/hicolor/scalable/apps/` | App icon (dock, launcher) |
| `assets/ClickSoundEffect.wav` | `/app/share/cpify/` | UI sound effects |
| `assets/CPify Dark Mode Logo.svg` | `/app/share/cpify/` | Splash screen logo (dark) |
| `assets/CPify Light Mode Logo.svg` | `/app/share/cpify/` | Splash screen logo (light) |
| `assets/CPify Official Logo.svg` | `/app/share/cpify/` | Official branding logo |

### How Assets Are Found at Runtime

The `config.h` header (generated by Meson) defines `CPIFY_ASSETS_DIR` which resolves to:
- **Flatpak:** `/app/share/cpify`
- **System install:** `/usr/share/cpify`

The `cpify_find_asset_path()` function in `src/cpify_app.c` searches for assets in order:

1. `CPIFY_ASSETS_DIR` (installed path -- `/app/share/cpify` in Flatpak)
2. `assets/` (relative -- development fallback)
3. `../assets/` (relative -- development fallback)
4. `../../assets/` (relative -- development fallback)

This means the same code works in both development (relative paths) and production
(installed paths inside the Flatpak sandbox).

### Adding a New Asset

To add a new asset file to the project:

1. **Place the file** in the `assets/` directory.
2. **Register it for installation** in `data/meson.build`:
   ```meson
   install_data(
     '../assets/YourNewFile.ext',
     install_dir: get_option('datadir') / 'cpify'
   )
   ```
3. **Load it in code** using `cpify_find_asset_path("YourNewFile.ext")`.
4. **Rebuild the Flatpak** -- the file will be installed to `/app/share/cpify/`.

### GStreamer Codec Support

The Flatpak manifest includes the `org.freedesktop.Platform.ffmpeg-full` extension
for broad media format support (MP3, AAC, FLAC, H.264, etc.). This is declared via
`add-extensions` in the manifest and requires the mount point `/app/lib/ffmpeg` to exist
(created by `cleanup-commands`).

## File Naming Conventions

### Application ID

The application ID follows reverse DNS notation:

```
com.github.dixonsolutions.CPify
```

This ID is used consistently across:
- Flatpak manifest filename
- Desktop file
- Metainfo file
- Icon filename
- D-Bus name

### Desktop File

**Filename:** `com.github.dixonsolutions.CPify.desktop`

Required fields:
- `Name`: Application display name
- `Exec`: Command to run (just `cpify`)
- `Icon`: Must match app ID (without extension)
- `Categories`: `AudioVideo;Audio;Video;Player;`

### MetaInfo File

**Filename:** `com.github.dixonsolutions.CPify.metainfo.xml`

This file provides:
- Application description for app stores
- Screenshots (optional)
- Release history
- Content rating

### Icon

**Filename:** `com.github.dixonsolutions.CPify.svg`

**Location:** `data/icons/hicolor/scalable/apps/`

Requirements:
- SVG format for scalable icons
- Must be named exactly as the app ID
- Will appear in dock, app launcher, and app stores

## Manifest Reference

The Flatpak manifest (`com.github.dixonsolutions.CPify.yml`) defines:

| Field | Value | Description |
|-------|-------|-------------|
| `app-id` | `com.github.dixonsolutions.CPify` | Unique application identifier |
| `runtime` | `org.gnome.Platform` | GNOME runtime for GTK4/libadwaita |
| `runtime-version` | `47` | GNOME platform version |
| `sdk` | `org.gnome.Sdk` | Build SDK |
| `command` | `cpify` | Executable to run |
| `add-extensions` | `org.freedesktop.Platform.ffmpeg-full` | GStreamer codecs for media playback |

### Permissions (finish-args)

| Permission | Purpose |
|------------|---------|
| `--share=ipc` | Shared memory for X11 |
| `--socket=fallback-x11` | X11 display (fallback) |
| `--socket=wayland` | Wayland display |
| `--socket=pulseaudio` | Audio playback |
| `--filesystem=home:ro` | Read access to home directory |
| `--filesystem=xdg-music:ro` | Read access to Music folder |
| `--filesystem=xdg-videos:ro` | Read access to Videos folder |
| `--share=network` | Network for update checking |
| `--device=dri` | GPU access for video acceleration |

## Updating the Flatpak

When releasing a new version:

1. Update version in `meson.build`
2. Add release entry to `metainfo.xml`
3. Rebuild the Flatpak
4. Create and distribute bundle or push to repository

### Adding a Release to MetaInfo

Edit `data/com.github.dixonsolutions.CPify.metainfo.xml`:

```xml
<releases>
  <release version="0.1.0" date="2026-03-01">
    <description>
      <p>New features and improvements</p>
      <ul>
        <li>Feature 1</li>
        <li>Feature 2</li>
      </ul>
    </description>
  </release>
  <!-- Previous releases below -->
</releases>
```

## Troubleshooting

### Build Fails with Missing Dependencies

Ensure the GNOME SDK is installed:

```bash
flatpak list --runtime | grep org.gnome.Sdk
```

### Icon Not Showing

1. Verify icon filename matches app ID exactly
2. Check icon is installed to correct path
3. Run `gtk-update-icon-cache` if needed

### App Won't Start

Check logs:

```bash
flatpak run --command=sh com.github.dixonsolutions.CPify
# Then run cpify manually to see errors
./cpify
```

### Assets Not Loading (No Sound, Missing Logo)

If assets like sounds or logos are missing at runtime:

1. Verify the asset is listed in `data/meson.build` under `install_data()`
2. Check it installs to the right path inside the sandbox:
   ```bash
   flatpak run --command=sh com.github.dixonsolutions.CPify
   ls /app/share/cpify/
   ```
3. Look for `[ASSETS] Warning: Could not find asset` in terminal output
4. Ensure filenames match exactly (case-sensitive)

### No Audio/Video Codec Support

If media files fail to play, ensure the ffmpeg extension is installed:

```bash
flatpak install flathub org.freedesktop.Platform.ffmpeg-full
```

## Publishing to Flathub

To publish on Flathub:

1. Fork the [Flathub repository](https://github.com/flathub/flathub)
2. Create a new branch with your app ID
3. Add your manifest file
4. Submit a pull request
5. Follow the [Flathub submission guidelines](https://github.com/flathub/flathub/wiki/App-Submission)

## Quick Reference

| Task | Command |
|------|---------|
| Build | `flatpak-builder --force-clean build-flatpak com.github.dixonsolutions.CPify.yml` |
| Install | `flatpak-builder --user --install --force-clean build-flatpak com.github.dixonsolutions.CPify.yml` |
| Run | `flatpak run com.github.dixonsolutions.CPify` |
| Uninstall | `flatpak uninstall com.github.dixonsolutions.CPify` |
| Bundle | `flatpak build-bundle repo cpify.flatpak com.github.dixonsolutions.CPify` |
